# Next.js项目单步调试完整指南

本指南将帮助你在Next.js项目中设置和使用单步调试功能，包括VSCode和浏览器两种调试方式。

## 目录
- [VSCode调试配置](#vscode调试配置)
- [浏览器调试设置](#浏览器调试设置)
- [断点使用技巧](#断点使用技巧)
- [实际调试示例](#实际调试示例)
- [常见问题排查](#常见问题排查)

## VSCode调试配置

### 1. 配置文件说明

我们已经在项目中创建了VSCode调试配置文件 `.vscode/launch.json`，其中包含三种调试模式：

- **Next.js: debug server-side**: 仅调试服务器端代码
- **Next.js: debug client-side**: 仅调试客户端代码
- **Next.js: debug full stack**: 同时调试服务器端和客户端代码

### 2. 启动VSCode调试

1. 在VSCode中打开项目文件夹
2. 点击左侧边栏的调试图标（或使用快捷键 `Cmd+Shift+D`）
3. 在调试配置下拉菜单中选择合适的调试模式
4. 点击绿色的「开始调试」按钮（或使用F5键）

### 3. 设置服务器端断点

在服务器端文件中（如API路由、服务器组件等）：

1. 打开你想要调试的TypeScript文件（如 `lib/api.ts`, `app/page.tsx` 等）
2. 点击代码行号旁边的空白区域设置断点
3. 当请求到达服务器端时，执行将在断点处暂停

### 4. 调试控制按钮

- **继续(F5)**: 继续执行直到下一个断点
- **单步跳过(F10)**: 执行当前行，不进入函数
- **单步进入(F11)**: 进入当前函数调用
- **单步退出(Shift+F11)**: 跳出当前函数

## 浏览器调试设置

详细的浏览器调试指南请参考我们创建的 `browser-debug-guide.md` 文件，这里简要介绍关键步骤：

1. 打开浏览器开发者工具 (`Cmd+Option+I` on Mac, `Ctrl+Shift+I` on Windows)
2. 切换到「Sources」(源代码)面板
3. 在左侧导航中找到你的源代码文件
4. 设置断点并使用调试控制按钮进行单步调试

## 断点使用技巧

### 1. 条件断点

在VSCode中：
1. 右键点击断点
2. 选择「编辑断点」
3. 输入条件表达式

在浏览器中：
1. 右键点击断点
2. 选择「Edit breakpoint」
3. 输入条件表达式

### 2. 日志点

VSCode中：
1. 右键点击行号
2. 选择「添加日志点」
3. 输入要记录到控制台的表达式（如 `"Value: " + variableName`）

这不会暂停执行，但会在控制台输出指定信息。

### 3. 函数断点

在VSCode中：
1. 在调试视图中点击「+」添加断点
2. 输入函数名（如 `fetchUserProfile`）
3. 调试器会在该函数被调用时暂停

## 实际调试示例

### 示例1: 调试API调用

假设你想调试 `lib/api.ts` 中的API调用：

1. 在 `lib/api.ts` 中找到API调用函数并设置断点
2. 启动调试会话
3. 在应用中触发该API调用
4. 调试器会在断点处暂停，你可以：
   - 检查请求参数
   - 单步跟踪执行流程
   - 查看响应数据

### 示例2: 调试React组件

调试 `components/workflow.tsx` 中的组件：

1. 在组件的关键函数（如 `handleSubmit`, `useEffect` 回调等）中设置断点
2. 在浏览器中加载包含该组件的页面
3. 触发相应的用户交互
4. 使用单步调试查看组件状态变化

## 调试模式与我们的日志系统集成

你可以结合项目中已实现的debug模式，在调试过程中查看更详细的日志信息：

1. 确保在 `.env` 文件中设置 `NEXT_PUBLIC_DEBUG=true`
2. 可选地设置日志级别 `NEXT_PUBLIC_DEBUG_LOG_LEVEL=debug`
3. 在调试过程中，控制台会显示更详细的信息，帮助你追踪问题

## 常见问题排查

### 断点未命中

- **检查路径映射**: 确保source maps正确配置
- **确认代码位置**: 确保断点设置在实际执行的代码上
- **检查环境**: 确认你使用的是正确的调试模式（服务器端或客户端）

### Next.js特定问题

- **React Server Components**: 服务器组件只能在服务器端调试模式下断点
- **Client Components**: 客户端组件可以在两种模式下调试
- **Next.js缓存**: 有时需要重启开发服务器才能应用某些更改

### 解决source maps问题

如果源代码映射不正确，尝试以下方法：

1. 确保 `next.config.js` 没有禁用source maps
2. 在VSCode的launch.json中检查sourceMapPathOverrides配置
3. 清除浏览器缓存并刷新页面

## 示例调试会话

### 步骤1: 启动调试服务器

```bash
# 在VSCode中选择 "Next.js: debug full stack" 并按F5
```

### 步骤2: 设置断点

在以下文件中设置断点：
- `lib/api.ts` - API调用函数
- `components/workflow.tsx` - 工作流处理逻辑
- `app/page.tsx` - 页面渲染逻辑

### 步骤3: 触发调试

在浏览器中访问应用并执行相关操作，触发断点。

### 步骤4: 分析和调试

使用单步调试工具：
1. 检查变量值
2. 跟踪执行流程
3. 修复问题或优化代码

---

现在你已经掌握了在Next.js项目中进行单步调试的完整方法。结合VSCode和浏览器调试工具，你可以高效地排查问题和优化代码。